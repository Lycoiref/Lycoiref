<!DOCTYPE html><html lang="zh"><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="stylesheet" href="/_next/static/css/5f88011d96ca9c55.css" crossorigin="" data-precedence="next"/><link rel="stylesheet" href="/_next/static/css/ccffada4a472fbc3.css" crossorigin="" data-precedence="next"/><link rel="stylesheet" href="/_next/static/css/57948b5676f14034.css" crossorigin="" data-precedence="next"/><link rel="preload" as="script" fetchPriority="low" href="/_next/static/chunks/webpack-ebfe3a98ee4588ad.js" crossorigin=""/><script src="/_next/static/chunks/fd9d1056-13342476f4426106.js" async="" crossorigin=""></script><script src="/_next/static/chunks/472-d102a6aa4acb2cca.js" async="" crossorigin=""></script><script src="/_next/static/chunks/main-app-98cd39aa05b2c661.js" async="" crossorigin=""></script><script src="/_next/static/chunks/app/layout-15577fefe046fd49.js" async=""></script><script src="/_next/static/chunks/app/pages/article/%5Bslug%5D/page-35769c6b29255f45.js" async=""></script><title>Lycoiref&#x27;s Blog</title><meta name="description" content="Generated by create next app"/><script src="/_next/static/chunks/polyfills-c67a75d1b6f99dc8.js" crossorigin="" noModule=""></script></head><body><div class="w-screen overflow-hidden h-0 top-bar transition-all duration-[1s]"><div class="row place-items-center h-full mx-auto w-full xl:w-3/5 font-bold"><div class="left col flex justify-start items-center font-thin"><i class="bi-activity text-[25px] mr-4"></i>Lycoiref&#x27;s Blog</div><div class="text-center col-8 flex justify-center font-thin"><div class="item"><i class="bi bi-house"></i><div class="text">首页</div></div><div class="item"><i class="bi bi-book"></i><div class="text">归档</div></div><div class="item"><i class="bi bi-chat-left-text"></i><div class="text">友链</div></div><div class="item"><i class="bi bi-image"></i><div class="text">图库</div></div><div class="hidden xl:block"><div class="item"><i class="bi bi-music-note-list"></i><div class="text">OST</div></div></div></div><div class="right col flex justify-end"><div class=" w-[40px] h-[40px]  cursor-pointer  hover:bg-slate-300  rounded-full  flex justify-center items-center transition-all duration-300 "><i class="bi bi-search text-[20px]"></i></div></div></div></div><canvas id="fireworks" class="fireworks"></canvas><div id="article-page" data-theme="light"><div class="header"><h1>在Nextjs中获取数据的正确姿势</h1><div>记录了如何正确在Nextjs中Fetch Data</div><div>11/26/2023</div></div><div class="article"><div class="markdown-body" data-theme="light"><nav class="toc"><ol><li><a href="#在-nextjs-中获取数据的正确姿势"> 在 Nextjs 中获取数据的正确姿势</a><ol><li><a href="#1.-server-side-rendering"> 1. Server Side Rendering</a></li><li><a href="#2.-使用routes-handler"> 2. 使用Routes Handler</a></li></ol></li></ol></nav><h1 id="%E5%9C%A8-nextjs-%E4%B8%AD%E8%8E%B7%E5%8F%96%E6%95%B0%E6%8D%AE%E7%9A%84%E6%AD%A3%E7%A1%AE%E5%A7%BF%E5%8A%BF" tabindex="-1"><a class="header-anchor" href="#%E5%9C%A8-nextjs-%E4%B8%AD%E8%8E%B7%E5%8F%96%E6%95%B0%E6%8D%AE%E7%9A%84%E6%AD%A3%E7%A1%AE%E5%A7%BF%E5%8A%BF">#</a> 在 Nextjs 中获取数据的正确姿势</h1>
<p>使用Next进行SSG时，Next允许我们使用一些服务端API，如fs，
这大大降低了我们获取数据的成本，但是在使用时，我们需要注意一些问题。</p>
<h2 id="1.-server-side-rendering" tabindex="-1"><a class="header-anchor" href="#1.-server-side-rendering">#</a> 1. Server Side Rendering</h2>
<p>因为我们SSG的最终目的是生成静态站点，因此我们的大部分组件都是需要使用
客户端API的，而这也是Next中很坑的一点：</p>
<p>虽然它向我们提供了服务端和客户端的API，但是这些API并不能在同一个文件中
混用，即如果你在一个页面中使用了<code>useEffect</code>，那么这个页面就不能使用
fs来读取文件，在以前的版本中一般使用<code>getStaticProps</code>来获取数据以及
调用服务端API，但是在<code>Next13</code>以及之后的版本中，这个API不允许在<code>pages</code>
路径下使用，取而代之的事<code>generateStaticParams</code>，且该API只允许返回
动态路由的slug，因此我们并不能像之前一样在此获取数据。</p>
<p>这时，最容易想到的解决方法就是封装一个子组件，并在子组件中使用<code>useEffect</code>
而父组件则作为SSR的入口：</p>
<pre><code class="language-jsx"><span class="hljs-comment">/* eslint-disable react-refresh/only-export-components */</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">ArticleCard</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./Card&#x27;</span>
<span class="hljs-keyword">import</span> {
  getMarkdownFiles,
  getMarkdownFileBySlug,
} <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;../../../utils/markdownUtils&#x27;</span>

<span class="hljs-keyword">export</span> interface <span class="hljs-title class_">Article</span> {
  <span class="hljs-attr">title</span>: string
  <span class="hljs-attr">author</span>: string
  <span class="hljs-attr">description</span>: string
  <span class="hljs-attr">date</span>: <span class="hljs-title class_">Date</span>
  <span class="hljs-attr">tags</span>: string[]
  <span class="hljs-attr">slug</span>: string
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">ArchivePage</span>(<span class="hljs-params"></span>) {
  <span class="hljs-keyword">let</span> files = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getMarkdownFiles</span>()
  files = files
    .<span class="hljs-title function_">filter</span>(<span class="hljs-function">(<span class="hljs-params">file</span>) =&gt;</span> file.<span class="hljs-title function_">match</span>(<span class="hljs-regexp">/\.md$/</span>))
    .<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">file</span>) =&gt;</span> file.<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/\.md$/</span>, <span class="hljs-string">&#x27;&#x27;</span>))
  <span class="hljs-keyword">const</span> <span class="hljs-attr">articles</span>: <span class="hljs-title class_">Array</span>&lt;<span class="hljs-title class_">Article</span>&gt; = []
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> file <span class="hljs-keyword">of</span> files) {
    <span class="hljs-keyword">const</span> { data } = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getMarkdownFileBySlug</span>(file)
    <span class="hljs-keyword">const</span> article = {
      <span class="hljs-attr">title</span>: data.<span class="hljs-property">title</span>,
      <span class="hljs-attr">author</span>: data.<span class="hljs-property">author</span>,
      <span class="hljs-attr">description</span>: data.<span class="hljs-property">description</span>,
      <span class="hljs-attr">date</span>: data.<span class="hljs-property">date</span>,
      <span class="hljs-attr">tags</span>: data.<span class="hljs-property">tags</span> || [],
      <span class="hljs-attr">slug</span>: file,
    }
    articles.<span class="hljs-title function_">push</span>(article)
  }

  <span class="hljs-keyword">return</span> (
    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Archive<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
      {articles.map((article) =&gt; (
        <span class="hljs-tag">&lt;<span class="hljs-name">ArticleCard</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{article.slug}</span> <span class="hljs-attr">article</span>=<span class="hljs-string">{article}</span> /&gt;</span>
      ))}
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  )
}

</code></pre>
<p>像这样获取数据之后，我们就会愉快的发现，至少在<code>yarn dev</code>中，一切都是
正常的，但是当我们进行部署到生产环境时，问题出现了：</p>
<p><img src="e81f89d3f428ca443fb7d36c433da6e6.png" alt="Alt text" /></p>
<p>打开控制台，我们就能看到一片红色的报错，虽然目前笔者还不清楚是什么原因
（欢迎大神指点），而且该页面除了有报错外其他表现均正常，但是既然出现报错
那么就说明这种方法不是官方推荐的，因此我们需要寻找其他方法。</p>
<h2 id="2.-%E4%BD%BF%E7%94%A8routes-handler" tabindex="-1"><a class="header-anchor" href="#2.-%E4%BD%BF%E7%94%A8routes-handler">#</a> 2. 使用Routes Handler</h2>
<p>查阅Next文档Data Fetching部分，我们可以看到其提供了一个<code>Routes Handler</code>
的API，该API可以在<code>pages/api</code>路径下使用，因此我们可以在该路径下创建一个
<code>route.ts</code>文件，该文件的内容如下（只是把数据获取的逻辑移动到了该文件中）：</p>
<div class="tip"><p>注意，此处的返回值必须是<code>Response</code>，且内容为json格式，否则会报错。</p>
</div>
<pre><code class="language-ts"><span class="hljs-keyword">import</span> {
  getMarkdownFiles,
  getMarkdownFileBySlug,
} <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;../../../../utils/markdownUtils&#x27;</span>

<span class="hljs-comment">// export const dynamic = &#x27;force-dynamic&#x27; // defaults to force-static</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">GET</span>(<span class="hljs-params"></span>) {
  <span class="hljs-comment">// console.log(request);</span>
  <span class="hljs-keyword">let</span> files = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getMarkdownFiles</span>()
  files = files
    .<span class="hljs-title function_">filter</span>(<span class="hljs-function">(<span class="hljs-params">file</span>) =&gt;</span> file.<span class="hljs-title function_">match</span>(<span class="hljs-regexp">/\.md$/</span>))
    .<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">file</span>) =&gt;</span> file.<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/\.md$/</span>, <span class="hljs-string">&#x27;&#x27;</span>))
  <span class="hljs-keyword">const</span> articles = []
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> file <span class="hljs-keyword">of</span> files) {
    <span class="hljs-keyword">const</span> { data } = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getMarkdownFileBySlug</span>(file)
    <span class="hljs-keyword">const</span> article = {
      <span class="hljs-attr">title</span>: data.<span class="hljs-property">title</span>,
      <span class="hljs-attr">author</span>: data.<span class="hljs-property">author</span>,
      <span class="hljs-attr">description</span>: data.<span class="hljs-property">description</span>,
      <span class="hljs-attr">date</span>: data.<span class="hljs-property">date</span>,
      <span class="hljs-attr">tags</span>: data.<span class="hljs-property">tags</span> || [],
      <span class="hljs-attr">slug</span>: file,
    }
    articles.<span class="hljs-title function_">push</span>(article)
  }
  <span class="hljs-comment">// return {</span>
  <span class="hljs-comment">//   props: {</span>
  <span class="hljs-comment">//     articles,</span>
  <span class="hljs-comment">//   },</span>
  <span class="hljs-comment">// }</span>
  <span class="hljs-keyword">return</span> <span class="hljs-title class_">Response</span>.<span class="hljs-title function_">json</span>({ articles })
}
</code></pre>
<p>而在原先的<code>page.tsx</code>中，我们则使用<code>useEffect</code>来获取数据：</p>
<pre><code class="language-jsx"><span class="hljs-comment">/* eslint-disable react-refresh/only-export-components */</span>
<span class="hljs-string">&#x27;use client&#x27;</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span>, { useEffect, useState } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">ArticleCard</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./Card&#x27;</span>

<span class="hljs-keyword">export</span> interface <span class="hljs-title class_">Article</span> {
  <span class="hljs-attr">title</span>: string
  <span class="hljs-attr">author</span>: string
  <span class="hljs-attr">description</span>: string
  <span class="hljs-attr">date</span>: <span class="hljs-title class_">Date</span>
  <span class="hljs-attr">tags</span>: string[]
  <span class="hljs-attr">slug</span>: string
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">ArchivePage</span>(<span class="hljs-params"></span>) {
  <span class="hljs-keyword">const</span> [articles, setArticles] = useState&lt;<span class="hljs-title class_">Article</span>[]&gt;([])
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">fetch</span>(<span class="hljs-string">&#x27;/pages/archive/api&#x27;</span>)
      .<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> res.<span class="hljs-title function_">json</span>())
      .<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> {
        <span class="hljs-title function_">setArticles</span>(res.<span class="hljs-property">articles</span>)
      })
  }, [])

  <span class="hljs-keyword">return</span> (
    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Archive<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
      {articles.map((article) =&gt; (
        <span class="hljs-tag">&lt;<span class="hljs-name">ArticleCard</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{article.slug}</span> <span class="hljs-attr">article</span>=<span class="hljs-string">{article}</span> /&gt;</span>
      ))}
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  )
}
</code></pre>
<p>分离出了数据获取的逻辑之后，我们就可以愉快的使用<code>useEffect</code>了，
build后再部署，可以看到控制台非常干净，而且页面也正常显示。我们
成功的解决了这个问题。</p>
</div></div><div class="changer_themeChanger__z_4GM" data-theme="light"><i class="bi-sun-fill changer_sunIcon__8VinH"></i><i class="bi-moon-fill changer_moonIcon__uAHwV"></i></div></div><script src="/_next/static/chunks/webpack-ebfe3a98ee4588ad.js" crossorigin="" async=""></script><script>(self.__next_f=self.__next_f||[]).push([0]);self.__next_f.push([2,null])</script><script>self.__next_f.push([1,"1:HL[\"/_next/static/css/5f88011d96ca9c55.css\",\"style\",{\"crossOrigin\":\"\"}]\n2:HL[\"/_next/static/css/ccffada4a472fbc3.css\",\"style\",{\"crossOrigin\":\"\"}]\n0:\"$L3\"\n"])</script><script>self.__next_f.push([1,"4:HL[\"/_next/static/css/57948b5676f14034.css\",\"style\",{\"crossOrigin\":\"\"}]\n"])</script><script>self.__next_f.push([1,"5:I[3728,[],\"\"]\n7:I[9928,[],\"\"]\n8:I[7420,[\"185\",\"static/chunks/app/layout-15577fefe046fd49.js\"],\"\"]\n9:I[8011,[\"185\",\"static/chunks/app/layout-15577fefe046fd49.js\"],\"Fireworks\"]\na:I[6954,[],\"\"]\nb:I[7264,[],\"\"]\n"])</script><script>self.__next_f.push([1,"3:[[[\"$\",\"link\",\"0\",{\"rel\":\"stylesheet\",\"href\":\"/_next/static/css/5f88011d96ca9c55.css\",\"precedence\":\"next\",\"crossOrigin\":\"\"}],[\"$\",\"link\",\"1\",{\"rel\":\"stylesheet\",\"href\":\"/_next/static/css/ccffada4a472fbc3.css\",\"precedence\":\"next\",\"crossOrigin\":\"\"}]],[\"$\",\"$L5\",null,{\"buildId\":\"Vy5Gye9M-cZAkh--dUNP8\",\"assetPrefix\":\"\",\"initialCanonicalUrl\":\"/pages/article/post2\",\"initialTree\":[\"\",{\"children\":[\"pages\",{\"children\":[\"article\",{\"children\":[[\"slug\",\"post2\",\"d\"],{\"children\":[\"__PAGE__?{\\\"slug\\\":\\\"post2\\\"}\",{}]}]}]}]},\"$undefined\",\"$undefined\",true],\"initialHead\":[false,\"$L6\"],\"globalErrorComponent\":\"$7\",\"children\":[null,[\"$\",\"html\",null,{\"lang\":\"zh\",\"children\":[\"$\",\"body\",null,{\"children\":[[\"$\",\"$L8\",null,{}],[\"$\",\"$L9\",null,{}],[\"$\",\"$La\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\"],\"loading\":\"$undefined\",\"loadingStyles\":\"$undefined\",\"loadingScripts\":\"$undefined\",\"hasLoading\":false,\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$Lb\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":[[\"$\",\"title\",null,{\"children\":\"404: This page could not be found.\"}],[\"$\",\"div\",null,{\"style\":{\"fontFamily\":\"system-ui,\\\"Segoe UI\\\",Roboto,Helvetica,Arial,sans-serif,\\\"Apple Color Emoji\\\",\\\"Segoe UI Emoji\\\"\",\"height\":\"100vh\",\"textAlign\":\"center\",\"display\":\"flex\",\"flexDirection\":\"column\",\"alignItems\":\"center\",\"justifyContent\":\"center\"},\"children\":[\"$\",\"div\",null,{\"children\":[[\"$\",\"style\",null,{\"dangerouslySetInnerHTML\":{\"__html\":\"body{color:#000;background:#fff;margin:0}.next-error-h1{border-right:1px solid rgba(0,0,0,.3)}@media (prefers-color-scheme:dark){body{color:#fff;background:#000}.next-error-h1{border-right:1px solid rgba(255,255,255,.3)}}\"}}],[\"$\",\"h1\",null,{\"className\":\"next-error-h1\",\"style\":{\"display\":\"inline-block\",\"margin\":\"0 20px 0 0\",\"padding\":\"0 23px 0 0\",\"fontSize\":24,\"fontWeight\":500,\"verticalAlign\":\"top\",\"lineHeight\":\"49px\"},\"children\":\"404\"}],[\"$\",\"div\",null,{\"style\":{\"display\":\"inline-block\"},\"children\":[\"$\",\"h2\",null,{\"style\":{\"fontSize\":14,\"fontWeight\":400,\"lineHeight\":\"49px\",\"margin\":0},\"children\":\"This page could not be found.\"}]}]]}]}]],\"notFoundStyles\":[],\"initialChildNode\":[\"$\",\"$La\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\",\"pages\",\"children\"],\"loading\":\"$undefined\",\"loadingStyles\":\"$undefined\",\"loadingScripts\":\"$undefined\",\"hasLoading\":false,\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$Lb\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":\"$undefined\",\"notFoundStyles\":\"$undefined\",\"initialChildNode\":[\"$\",\"$La\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\",\"pages\",\"children\",\"article\",\"children\"],\"loading\":\"$undefined\",\"loadingStyles\":\"$undefined\",\"loadingScripts\":\"$undefined\",\"hasLoading\":false,\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$Lb\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":\"$undefined\",\"notFoundStyles\":\"$undefined\",\"initialChildNode\":[\"$\",\"$La\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\",\"pages\",\"children\",\"article\",\"children\",[\"slug\",\"post2\",\"d\"],\"children\"],\"loading\":\"$undefined\",\"loadingStyles\":\"$undefined\",\"loadingScripts\":\"$undefined\",\"hasLoading\":false,\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$Lb\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":\"$undefined\",\"notFoundStyles\":\"$undefined\",\"initialChildNode\":[\"$Lc\",\"$Ld\",null],\"childPropSegment\":\"__PAGE__?{\\\"slug\\\":\\\"post2\\\"}\",\"styles\":[[\"$\",\"link\",\"0\",{\"rel\":\"stylesheet\",\"href\":\"/_next/static/css/57948b5676f14034.css\",\"precedence\":\"next\",\"crossOrigin\":\"\"}]]}],\"childPropSegment\":[\"slug\",\"post2\",\"d\"],\"styles\":null}],\"childPropSegment\":\"article\",\"styles\":null}],\"childPropSegment\":\"pages\",\"styles\":null}]]}]}],null]}]]\n"])</script><script>self.__next_f.push([1,"e:I[6930,[\"395\",\"static/chunks/app/pages/article/%5Bslug%5D/page-35769c6b29255f45.js\"],\"\"]\nf:T31ee,"])</script><script>self.__next_f.push([1,"\u003cnav class=\"toc\"\u003e\u003col\u003e\u003cli\u003e\u003ca href=\"#在-nextjs-中获取数据的正确姿势\"\u003e 在 Nextjs 中获取数据的正确姿势\u003c/a\u003e\u003col\u003e\u003cli\u003e\u003ca href=\"#1.-server-side-rendering\"\u003e 1. Server Side Rendering\u003c/a\u003e\u003c/li\u003e\u003cli\u003e\u003ca href=\"#2.-使用routes-handler\"\u003e 2. 使用Routes Handler\u003c/a\u003e\u003c/li\u003e\u003c/ol\u003e\u003c/li\u003e\u003c/ol\u003e\u003c/nav\u003e\u003ch1 id=\"%E5%9C%A8-nextjs-%E4%B8%AD%E8%8E%B7%E5%8F%96%E6%95%B0%E6%8D%AE%E7%9A%84%E6%AD%A3%E7%A1%AE%E5%A7%BF%E5%8A%BF\" tabindex=\"-1\"\u003e\u003ca class=\"header-anchor\" href=\"#%E5%9C%A8-nextjs-%E4%B8%AD%E8%8E%B7%E5%8F%96%E6%95%B0%E6%8D%AE%E7%9A%84%E6%AD%A3%E7%A1%AE%E5%A7%BF%E5%8A%BF\"\u003e#\u003c/a\u003e 在 Nextjs 中获取数据的正确姿势\u003c/h1\u003e\n\u003cp\u003e使用Next进行SSG时，Next允许我们使用一些服务端API，如fs，\n这大大降低了我们获取数据的成本，但是在使用时，我们需要注意一些问题。\u003c/p\u003e\n\u003ch2 id=\"1.-server-side-rendering\" tabindex=\"-1\"\u003e\u003ca class=\"header-anchor\" href=\"#1.-server-side-rendering\"\u003e#\u003c/a\u003e 1. Server Side Rendering\u003c/h2\u003e\n\u003cp\u003e因为我们SSG的最终目的是生成静态站点，因此我们的大部分组件都是需要使用\n客户端API的，而这也是Next中很坑的一点：\u003c/p\u003e\n\u003cp\u003e虽然它向我们提供了服务端和客户端的API，但是这些API并不能在同一个文件中\n混用，即如果你在一个页面中使用了\u003ccode\u003euseEffect\u003c/code\u003e，那么这个页面就不能使用\nfs来读取文件，在以前的版本中一般使用\u003ccode\u003egetStaticProps\u003c/code\u003e来获取数据以及\n调用服务端API，但是在\u003ccode\u003eNext13\u003c/code\u003e以及之后的版本中，这个API不允许在\u003ccode\u003epages\u003c/code\u003e\n路径下使用，取而代之的事\u003ccode\u003egenerateStaticParams\u003c/code\u003e，且该API只允许返回\n动态路由的slug，因此我们并不能像之前一样在此获取数据。\u003c/p\u003e\n\u003cp\u003e这时，最容易想到的解决方法就是封装一个子组件，并在子组件中使用\u003ccode\u003euseEffect\u003c/code\u003e\n而父组件则作为SSR的入口：\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-jsx\"\u003e\u003cspan class=\"hljs-comment\"\u003e/* eslint-disable react-refresh/only-export-components */\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eReact\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003efrom\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\u0026#x27;react\u0026#x27;\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eArticleCard\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003efrom\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\u0026#x27;./Card\u0026#x27;\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e {\n  getMarkdownFiles,\n  getMarkdownFileBySlug,\n} \u003cspan class=\"hljs-keyword\"\u003efrom\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\u0026#x27;../../../utils/markdownUtils\u0026#x27;\u003c/span\u003e\n\n\u003cspan class=\"hljs-keyword\"\u003eexport\u003c/span\u003e interface \u003cspan class=\"hljs-title class_\"\u003eArticle\u003c/span\u003e {\n  \u003cspan class=\"hljs-attr\"\u003etitle\u003c/span\u003e: string\n  \u003cspan class=\"hljs-attr\"\u003eauthor\u003c/span\u003e: string\n  \u003cspan class=\"hljs-attr\"\u003edescription\u003c/span\u003e: string\n  \u003cspan class=\"hljs-attr\"\u003edate\u003c/span\u003e: \u003cspan class=\"hljs-title class_\"\u003eDate\u003c/span\u003e\n  \u003cspan class=\"hljs-attr\"\u003etags\u003c/span\u003e: string[]\n  \u003cspan class=\"hljs-attr\"\u003eslug\u003c/span\u003e: string\n}\n\n\u003cspan class=\"hljs-keyword\"\u003eexport\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003edefault\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003easync\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003eArchivePage\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003e\u003c/span\u003e) {\n  \u003cspan class=\"hljs-keyword\"\u003elet\u003c/span\u003e files = \u003cspan class=\"hljs-keyword\"\u003eawait\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003egetMarkdownFiles\u003c/span\u003e()\n  files = files\n    .\u003cspan class=\"hljs-title function_\"\u003efilter\u003c/span\u003e(\u003cspan class=\"hljs-function\"\u003e(\u003cspan class=\"hljs-params\"\u003efile\u003c/span\u003e) =\u0026gt;\u003c/span\u003e file.\u003cspan class=\"hljs-title function_\"\u003ematch\u003c/span\u003e(\u003cspan class=\"hljs-regexp\"\u003e/\\.md$/\u003c/span\u003e))\n    .\u003cspan class=\"hljs-title function_\"\u003emap\u003c/span\u003e(\u003cspan class=\"hljs-function\"\u003e(\u003cspan class=\"hljs-params\"\u003efile\u003c/span\u003e) =\u0026gt;\u003c/span\u003e file.\u003cspan class=\"hljs-title function_\"\u003ereplace\u003c/span\u003e(\u003cspan class=\"hljs-regexp\"\u003e/\\.md$/\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e\u0026#x27;\u0026#x27;\u003c/span\u003e))\n  \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003earticles\u003c/span\u003e: \u003cspan class=\"hljs-title class_\"\u003eArray\u003c/span\u003e\u0026lt;\u003cspan class=\"hljs-title class_\"\u003eArticle\u003c/span\u003e\u0026gt; = []\n  \u003cspan class=\"hljs-keyword\"\u003efor\u003c/span\u003e (\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e file \u003cspan class=\"hljs-keyword\"\u003eof\u003c/span\u003e files) {\n    \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e { data } = \u003cspan class=\"hljs-keyword\"\u003eawait\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003egetMarkdownFileBySlug\u003c/span\u003e(file)\n    \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e article = {\n      \u003cspan class=\"hljs-attr\"\u003etitle\u003c/span\u003e: data.\u003cspan class=\"hljs-property\"\u003etitle\u003c/span\u003e,\n      \u003cspan class=\"hljs-attr\"\u003eauthor\u003c/span\u003e: data.\u003cspan class=\"hljs-property\"\u003eauthor\u003c/span\u003e,\n      \u003cspan class=\"hljs-attr\"\u003edescription\u003c/span\u003e: data.\u003cspan class=\"hljs-property\"\u003edescription\u003c/span\u003e,\n      \u003cspan class=\"hljs-attr\"\u003edate\u003c/span\u003e: data.\u003cspan class=\"hljs-property\"\u003edate\u003c/span\u003e,\n      \u003cspan class=\"hljs-attr\"\u003etags\u003c/span\u003e: data.\u003cspan class=\"hljs-property\"\u003etags\u003c/span\u003e || [],\n      \u003cspan class=\"hljs-attr\"\u003eslug\u003c/span\u003e: file,\n    }\n    articles.\u003cspan class=\"hljs-title function_\"\u003epush\u003c/span\u003e(article)\n  }\n\n  \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e (\n    \u003cspan class=\"language-xml\"\u003e\u003cspan class=\"hljs-tag\"\u003e\u0026lt;\u003cspan class=\"hljs-name\"\u003ediv\u003c/span\u003e\u0026gt;\u003c/span\u003e\n      \u003cspan class=\"hljs-tag\"\u003e\u0026lt;\u003cspan class=\"hljs-name\"\u003eh1\u003c/span\u003e\u0026gt;\u003c/span\u003eArchive\u003cspan class=\"hljs-tag\"\u003e\u0026lt;/\u003cspan class=\"hljs-name\"\u003eh1\u003c/span\u003e\u0026gt;\u003c/span\u003e\n      {articles.map((article) =\u0026gt; (\n        \u003cspan class=\"hljs-tag\"\u003e\u0026lt;\u003cspan class=\"hljs-name\"\u003eArticleCard\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003ekey\u003c/span\u003e=\u003cspan class=\"hljs-string\"\u003e{article.slug}\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003earticle\u003c/span\u003e=\u003cspan class=\"hljs-string\"\u003e{article}\u003c/span\u003e /\u0026gt;\u003c/span\u003e\n      ))}\n    \u003cspan class=\"hljs-tag\"\u003e\u0026lt;/\u003cspan class=\"hljs-name\"\u003ediv\u003c/span\u003e\u0026gt;\u003c/span\u003e\u003c/span\u003e\n  )\n}\n\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e像这样获取数据之后，我们就会愉快的发现，至少在\u003ccode\u003eyarn dev\u003c/code\u003e中，一切都是\n正常的，但是当我们进行部署到生产环境时，问题出现了：\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"e81f89d3f428ca443fb7d36c433da6e6.png\" alt=\"Alt text\" /\u003e\u003c/p\u003e\n\u003cp\u003e打开控制台，我们就能看到一片红色的报错，虽然目前笔者还不清楚是什么原因\n（欢迎大神指点），而且该页面除了有报错外其他表现均正常，但是既然出现报错\n那么就说明这种方法不是官方推荐的，因此我们需要寻找其他方法。\u003c/p\u003e\n\u003ch2 id=\"2.-%E4%BD%BF%E7%94%A8routes-handler\" tabindex=\"-1\"\u003e\u003ca class=\"header-anchor\" href=\"#2.-%E4%BD%BF%E7%94%A8routes-handler\"\u003e#\u003c/a\u003e 2. 使用Routes Handler\u003c/h2\u003e\n\u003cp\u003e查阅Next文档Data Fetching部分，我们可以看到其提供了一个\u003ccode\u003eRoutes Handler\u003c/code\u003e\n的API，该API可以在\u003ccode\u003epages/api\u003c/code\u003e路径下使用，因此我们可以在该路径下创建一个\n\u003ccode\u003eroute.ts\u003c/code\u003e文件，该文件的内容如下（只是把数据获取的逻辑移动到了该文件中）：\u003c/p\u003e\n\u003cdiv class=\"tip\"\u003e\u003cp\u003e注意，此处的返回值必须是\u003ccode\u003eResponse\u003c/code\u003e，且内容为json格式，否则会报错。\u003c/p\u003e\n\u003c/div\u003e\n\u003cpre\u003e\u003ccode class=\"language-ts\"\u003e\u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e {\n  getMarkdownFiles,\n  getMarkdownFileBySlug,\n} \u003cspan class=\"hljs-keyword\"\u003efrom\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\u0026#x27;../../../../utils/markdownUtils\u0026#x27;\u003c/span\u003e\n\n\u003cspan class=\"hljs-comment\"\u003e// export const dynamic = \u0026#x27;force-dynamic\u0026#x27; // defaults to force-static\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003eexport\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003easync\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003eGET\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003e\u003c/span\u003e) {\n  \u003cspan class=\"hljs-comment\"\u003e// console.log(request);\u003c/span\u003e\n  \u003cspan class=\"hljs-keyword\"\u003elet\u003c/span\u003e files = \u003cspan class=\"hljs-keyword\"\u003eawait\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003egetMarkdownFiles\u003c/span\u003e()\n  files = files\n    .\u003cspan class=\"hljs-title function_\"\u003efilter\u003c/span\u003e(\u003cspan class=\"hljs-function\"\u003e(\u003cspan class=\"hljs-params\"\u003efile\u003c/span\u003e) =\u0026gt;\u003c/span\u003e file.\u003cspan class=\"hljs-title function_\"\u003ematch\u003c/span\u003e(\u003cspan class=\"hljs-regexp\"\u003e/\\.md$/\u003c/span\u003e))\n    .\u003cspan class=\"hljs-title function_\"\u003emap\u003c/span\u003e(\u003cspan class=\"hljs-function\"\u003e(\u003cspan class=\"hljs-params\"\u003efile\u003c/span\u003e) =\u0026gt;\u003c/span\u003e file.\u003cspan class=\"hljs-title function_\"\u003ereplace\u003c/span\u003e(\u003cspan class=\"hljs-regexp\"\u003e/\\.md$/\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e\u0026#x27;\u0026#x27;\u003c/span\u003e))\n  \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e articles = []\n  \u003cspan class=\"hljs-keyword\"\u003efor\u003c/span\u003e (\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e file \u003cspan class=\"hljs-keyword\"\u003eof\u003c/span\u003e files) {\n    \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e { data } = \u003cspan class=\"hljs-keyword\"\u003eawait\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003egetMarkdownFileBySlug\u003c/span\u003e(file)\n    \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e article = {\n      \u003cspan class=\"hljs-attr\"\u003etitle\u003c/span\u003e: data.\u003cspan class=\"hljs-property\"\u003etitle\u003c/span\u003e,\n      \u003cspan class=\"hljs-attr\"\u003eauthor\u003c/span\u003e: data.\u003cspan class=\"hljs-property\"\u003eauthor\u003c/span\u003e,\n      \u003cspan class=\"hljs-attr\"\u003edescription\u003c/span\u003e: data.\u003cspan class=\"hljs-property\"\u003edescription\u003c/span\u003e,\n      \u003cspan class=\"hljs-attr\"\u003edate\u003c/span\u003e: data.\u003cspan class=\"hljs-property\"\u003edate\u003c/span\u003e,\n      \u003cspan class=\"hljs-attr\"\u003etags\u003c/span\u003e: data.\u003cspan class=\"hljs-property\"\u003etags\u003c/span\u003e || [],\n      \u003cspan class=\"hljs-attr\"\u003eslug\u003c/span\u003e: file,\n    }\n    articles.\u003cspan class=\"hljs-title function_\"\u003epush\u003c/span\u003e(article)\n  }\n  \u003cspan class=\"hljs-comment\"\u003e// return {\u003c/span\u003e\n  \u003cspan class=\"hljs-comment\"\u003e//   props: {\u003c/span\u003e\n  \u003cspan class=\"hljs-comment\"\u003e//     articles,\u003c/span\u003e\n  \u003cspan class=\"hljs-comment\"\u003e//   },\u003c/span\u003e\n  \u003cspan class=\"hljs-comment\"\u003e// }\u003c/span\u003e\n  \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eResponse\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003ejson\u003c/span\u003e({ articles })\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e而在原先的\u003ccode\u003epage.tsx\u003c/code\u003e中，我们则使用\u003ccode\u003euseEffect\u003c/code\u003e来获取数据：\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-jsx\"\u003e\u003cspan class=\"hljs-comment\"\u003e/* eslint-disable react-refresh/only-export-components */\u003c/span\u003e\n\u003cspan class=\"hljs-string\"\u003e\u0026#x27;use client\u0026#x27;\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eReact\u003c/span\u003e, { useEffect, useState } \u003cspan class=\"hljs-keyword\"\u003efrom\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\u0026#x27;react\u0026#x27;\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eArticleCard\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003efrom\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\u0026#x27;./Card\u0026#x27;\u003c/span\u003e\n\n\u003cspan class=\"hljs-keyword\"\u003eexport\u003c/span\u003e interface \u003cspan class=\"hljs-title class_\"\u003eArticle\u003c/span\u003e {\n  \u003cspan class=\"hljs-attr\"\u003etitle\u003c/span\u003e: string\n  \u003cspan class=\"hljs-attr\"\u003eauthor\u003c/span\u003e: string\n  \u003cspan class=\"hljs-attr\"\u003edescription\u003c/span\u003e: string\n  \u003cspan class=\"hljs-attr\"\u003edate\u003c/span\u003e: \u003cspan class=\"hljs-title class_\"\u003eDate\u003c/span\u003e\n  \u003cspan class=\"hljs-attr\"\u003etags\u003c/span\u003e: string[]\n  \u003cspan class=\"hljs-attr\"\u003eslug\u003c/span\u003e: string\n}\n\n\u003cspan class=\"hljs-keyword\"\u003eexport\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003edefault\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003eArchivePage\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003e\u003c/span\u003e) {\n  \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e [articles, setArticles] = useState\u0026lt;\u003cspan class=\"hljs-title class_\"\u003eArticle\u003c/span\u003e[]\u0026gt;([])\n  \u003cspan class=\"hljs-title function_\"\u003euseEffect\u003c/span\u003e(\u003cspan class=\"hljs-function\"\u003e() =\u0026gt;\u003c/span\u003e {\n    \u003cspan class=\"hljs-title function_\"\u003efetch\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026#x27;/pages/archive/api\u0026#x27;\u003c/span\u003e)\n      .\u003cspan class=\"hljs-title function_\"\u003ethen\u003c/span\u003e(\u003cspan class=\"hljs-function\"\u003e(\u003cspan class=\"hljs-params\"\u003eres\u003c/span\u003e) =\u0026gt;\u003c/span\u003e res.\u003cspan class=\"hljs-title function_\"\u003ejson\u003c/span\u003e())\n      .\u003cspan class=\"hljs-title function_\"\u003ethen\u003c/span\u003e(\u003cspan class=\"hljs-function\"\u003e(\u003cspan class=\"hljs-params\"\u003eres\u003c/span\u003e) =\u0026gt;\u003c/span\u003e {\n        \u003cspan class=\"hljs-title function_\"\u003esetArticles\u003c/span\u003e(res.\u003cspan class=\"hljs-property\"\u003earticles\u003c/span\u003e)\n      })\n  }, [])\n\n  \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e (\n    \u003cspan class=\"language-xml\"\u003e\u003cspan class=\"hljs-tag\"\u003e\u0026lt;\u003cspan class=\"hljs-name\"\u003ediv\u003c/span\u003e\u0026gt;\u003c/span\u003e\n      \u003cspan class=\"hljs-tag\"\u003e\u0026lt;\u003cspan class=\"hljs-name\"\u003eh1\u003c/span\u003e\u0026gt;\u003c/span\u003eArchive\u003cspan class=\"hljs-tag\"\u003e\u0026lt;/\u003cspan class=\"hljs-name\"\u003eh1\u003c/span\u003e\u0026gt;\u003c/span\u003e\n      {articles.map((article) =\u0026gt; (\n        \u003cspan class=\"hljs-tag\"\u003e\u0026lt;\u003cspan class=\"hljs-name\"\u003eArticleCard\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003ekey\u003c/span\u003e=\u003cspan class=\"hljs-string\"\u003e{article.slug}\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003earticle\u003c/span\u003e=\u003cspan class=\"hljs-string\"\u003e{article}\u003c/span\u003e /\u0026gt;\u003c/span\u003e\n      ))}\n    \u003cspan class=\"hljs-tag\"\u003e\u0026lt;/\u003cspan class=\"hljs-name\"\u003ediv\u003c/span\u003e\u0026gt;\u003c/span\u003e\u003c/span\u003e\n  )\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e分离出了数据获取的逻辑之后，我们就可以愉快的使用\u003ccode\u003euseEffect\u003c/code\u003e了，\nbuild后再部署，可以看到控制台非常干净，而且页面也正常显示。我们\n成功的解决了这个问题。\u003c/p\u003e\n"])</script><script>self.__next_f.push([1,"d:[\"$\",\"$Le\",null,{\"data\":{\"title\":\"在Nextjs中获取数据的正确姿势\",\"description\":\"记录了如何正确在Nextjs中Fetch Data\",\"date\":\"$D2023-11-26T00:00:00.000Z\",\"author\":\"Lycoiref\"},\"content\":\"$f\"}]\n6:[[\"$\",\"meta\",\"0\",{\"name\":\"viewport\",\"content\":\"width=device-width, initial-scale=1\"}],[\"$\",\"meta\",\"1\",{\"charSet\":\"utf-8\"}],[\"$\",\"title\",\"2\",{\"children\":\"Lycoiref's Blog\"}],[\"$\",\"meta\",\"3\",{\"name\":\"description\",\"content\":\"Generated by create next app\"}]]\nc:null\n"])</script><script>self.__next_f.push([1,""])</script></body></html>